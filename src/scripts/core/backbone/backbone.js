define(function(require,exports,module){!function(root,factory){if("function"==typeof define&&define.amd)define(["underscore","jquery","exports"],function(_,$,exports){root.Backbone=factory(root,exports,_,$)});else if("undefined"!=typeof exports){var _=require("underscore");factory(root,exports,_)}else root.Backbone=factory(root,{},root._,root.jQuery||root.Zepto||root.ender||root.$)}(this,function(root,Backbone,_,$){$=require("jquery");var previousBackbone=root.Backbone,array=[],slice=array.slice;Backbone.VERSION="1.1.2",Backbone.$=$,Backbone.noConflict=function(){return root.Backbone=previousBackbone,this},Backbone.emulateHTTP=!1,Backbone.emulateJSON=!1;var Events=Backbone.Events={},eventSplitter=/\s+/,eventsApi=function(iteratee,memo,name,callback,context,ctx){var names,length,i=0;if(name&&"object"==typeof name)for(names=_.keys(name),length=names.length;length>i;i++)memo=iteratee(memo,names[i],name[names[i]],context,ctx);else if(name&&eventSplitter.test(name))for(names=name.split(eventSplitter),length=names.length;length>i;i++)memo=iteratee(memo,names[i],callback,context,ctx);else memo=iteratee(memo,name,callback,context,ctx);return memo};Events.on=function(name,callback,context){return this._events=eventsApi(onApi,this._events||{},name,callback,context,this),this},Events.listenTo=function(obj,name,callback){if(!obj)return this;var id=obj._listenId||(obj._listenId=_.uniqueId("l")),listeningTo=this._listeningTo||(this._listeningTo={}),listening=listeningTo[id];if(!listening){listening=listeningTo[id]={obj:obj,events:{}},id=this._listenId||(this._listenId=_.uniqueId("l"));var listeners=obj._listeners||(obj._listeners={});listeners[id]=this}return obj.on(name,callback,this),listening.events=eventsApi(onApi,listening.events,name,callback),this};var onApi=function(events,name,callback,context,ctx){if(callback){var handlers=events[name]||(events[name]=[]);handlers.push({callback:callback,context:context,ctx:context||ctx})}return events};Events.off=function(name,callback,context){if(!this._events)return this;this._events=eventsApi(offApi,this._events,name,callback,context);var listeners=this._listeners;if(listeners){for(var ids=null!=context?[context._listenId]:_.keys(listeners),i=0,length=ids.length;length>i;i++){var listener=listeners[ids[i]];if(!listener)break;internalStopListening(listener,this,name,callback)}_.isEmpty(listeners)&&(this._listeners=void 0)}return this},Events.stopListening=function(obj,name,callback){return this._listeningTo&&internalStopListening(this,obj,name,callback,!0),this};var offApi=function(events,name,callback,context){if(events&&(name||context||callback)){for(var names=name?[name]:_.keys(events),i=0,length=names.length;length>i;i++){name=names[i];var handlers=events[name];if(!handlers)break;var remaining=[];if(callback||context)for(var j=0,k=handlers.length;k>j;j++){var handler=handlers[j];(callback&&callback!==handler.callback&&callback!==handler.callback._callback||context&&context!==handler.context)&&remaining.push(handler)}remaining.length?events[name]=remaining:delete events[name]}return _.isEmpty(events)?void 0:events}},internalStopListening=function(listener,obj,name,callback,offEvents){for(var listeningTo=listener._listeningTo,ids=obj?[obj._listenId]:_.keys(listeningTo),i=0,length=ids.length;length>i;i++){var id=ids[i],listening=listeningTo[id];if(!listening)break;obj=listening.obj,offEvents&&(obj._events=eventsApi(offApi,obj._events,name,callback,listener));var events=eventsApi(offApi,listening.events,name,callback);events||(delete listeningTo[id],delete listening.obj._listeners[listener._listenId])}_.isEmpty(listeningTo)&&(listener._listeningTo=void 0)};Events.once=function(name,callback,context){var events=onceMap(name,callback,_.bind(this.off,this));return this.on(events,void 0,context)},Events.listenToOnce=function(obj,name,callback){var events=onceMap(name,callback,_.bind(this.stopListening,this,obj));return this.listenTo(obj,events)};var onceMap=function(name,callback,offer){return eventsApi(function(map,name,callback,offer){if(callback){var once=map[name]=_.once(function(){offer(name,once),callback.apply(this,arguments)});once._callback=callback}return map},{},name,callback,offer)};Events.trigger=function(name){if(!this._events)return this;var args=slice.call(arguments,1);return eventsApi(triggerApi,this,name,triggerSentinel,args),this};var triggerSentinel={},triggerApi=function(obj,name,sentinel,args){if(obj._events){sentinel!==triggerSentinel&&(args=[sentinel].concat(args));var events=obj._events[name],allEvents=obj._events.all;events&&triggerEvents(events,args),allEvents&&triggerEvents(allEvents,[name].concat(args))}return obj},triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx);return;case 1:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:for(;++i<l;)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:for(;++i<l;)(ev=events[i]).callback.apply(ev.ctx,args);return}};Events.bind=Events.on,Events.unbind=Events.off,_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var attrs=attributes||{};options||(options={}),this.cid=_.uniqueId("c"),this.attributes={},options.collection&&(this.collection=options.collection),options.parse&&(attrs=this.parse(attrs,options)||{}),attrs=_.defaults({},attrs,_.result(this,"defaults")),this.set(attrs,options),this.changed={},this.initialize.apply(this,arguments)};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(options){return _.clone(this.attributes)},sync:function(){return Backbone.sync.apply(this,arguments)},get:function(attr){return this.attributes[attr]},escape:function(attr){return _.escape(this.get(attr))},has:function(attr){return null!=this.get(attr)},matches:function(attrs){return _.matches(attrs)(this.attributes)},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(null==key)return this;if("object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options||(options={}),!this._validate(attrs,options))return!1;unset=options.unset,silent=options.silent,changes=[],changing=this._changing,this._changing=!0,changing||(this._previousAttributes=_.clone(this.attributes),this.changed={}),current=this.attributes,prev=this._previousAttributes,this.idAttribute in attrs&&(this.id=attrs[this.idAttribute]);for(attr in attrs)val=attrs[attr],_.isEqual(current[attr],val)||changes.push(attr),_.isEqual(prev[attr],val)?delete this.changed[attr]:this.changed[attr]=val,unset?delete current[attr]:current[attr]=val;if(!silent){changes.length&&(this._pending=options);for(var i=0,length=changes.length;length>i;i++)this.trigger("change:"+changes[i],this,current[changes[i]],options)}if(changing)return this;if(!silent)for(;this._pending;)options=this._pending,this._pending=!1,this.trigger("change",this,options);return this._pending=!1,this._changing=!1,this},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:!0}))},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:!0}))},hasChanged:function(attr){return null==attr?!_.isEmpty(this.changed):_.has(this.changed,attr)},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):!1;var val,changed=!1,old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff)_.isEqual(old[attr],val=diff[attr])||((changed||(changed={}))[attr]=val);return changed},previous:function(attr){return null!=attr&&this._previousAttributes?this._previousAttributes[attr]:null},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(options){options=options?_.clone(options):{},void 0===options.parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){return model.set(model.parse(resp,options),options)?(success&&success.call(options.context,model,resp,options),void model.trigger("sync",model,resp,options)):!1},wrapError(this,options),this.sync("read",this,options)},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(null==key||"object"==typeof key?(attrs=key,options=val):(attrs={})[key]=val,options=_.extend({validate:!0},options),attrs&&!options.wait){if(!this.set(attrs,options))return!1}else if(!this._validate(attrs,options))return!1;attrs&&options.wait&&(this.attributes=_.extend({},attributes,attrs)),void 0===options.parse&&(options.parse=!0);var model=this,success=options.success;return options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);return options.wait&&(serverAttrs=_.extend(attrs||{},serverAttrs)),_.isObject(serverAttrs)&&!model.set(serverAttrs,options)?!1:(success&&success.call(options.context,model,resp,options),void model.trigger("sync",model,resp,options))},wrapError(this,options),method=this.isNew()?"create":options.patch?"patch":"update","patch"!==method||options.attrs||(options.attrs=attrs),xhr=this.sync(method,this,options),attrs&&options.wait&&(this.attributes=attributes),xhr},destroy:function(options){options=options?_.clone(options):{};var model=this,success=options.success,destroy=function(){model.stopListening(),model.trigger("destroy",model,model.collection,options)};if(options.success=function(resp){(options.wait||model.isNew())&&destroy(),success&&success.call(options.context,model,resp,options),model.isNew()||model.trigger("sync",model,resp,options)},this.isNew())return options.success(),!1;wrapError(this,options);var xhr=this.sync("delete",this,options);return options.wait||destroy(),xhr},url:function(){var base=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew())return base;var id=this.id||this.attributes[this.idAttribute];return base.replace(/([^\/])$/,"$1/")+encodeURIComponent(id)},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(options){return this._validate({},_.extend(options||{},{validate:!0}))},_validate:function(attrs,options){if(!options.validate||!this.validate)return!0;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;return error?(this.trigger("invalid",this,error,_.extend(options,{validationError:error})),!1):!0}});var modelMethods=["keys","values","pairs","invert","pick","omit","chain","isEmpty"];_.each(modelMethods,function(method){_[method]&&(Model.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.attributes),_[method].apply(_,args)})});var Collection=Backbone.Collection=function(models,options){options||(options={}),options.model&&(this.model=options.model),void 0!==options.comparator&&(this.comparator=options.comparator),this._reset(),this.initialize.apply(this,arguments),models&&this.reset(models,_.extend({silent:!0},options))},setOptions={add:!0,remove:!0,merge:!0},addOptions={add:!0,remove:!1};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})},sync:function(){return Backbone.sync.apply(this,arguments)},add:function(models,options){return this.set(models,_.extend({merge:!1},options,addOptions))},remove:function(models,options){var singular=!_.isArray(models);models=singular?[models]:_.clone(models),options||(options={});for(var i=0,length=models.length;length>i;i++){var model=models[i]=this.get(models[i]);if(model){var id=this.modelId(model.attributes);null!=id&&delete this._byId[id],delete this._byId[model.cid];var index=this.indexOf(model);this.models.splice(index,1),this.length--,options.silent||(options.index=index,model.trigger("remove",model,this,options)),this._removeReference(model,options)}}return singular?models[0]:models},set:function(models,options){options=_.defaults({},options,setOptions),options.parse&&(models=this.parse(models,options));var singular=!_.isArray(models);models=singular?models?[models]:[]:models.slice();var id,model,attrs,existing,sort,at=options.at;null!=at&&(at=+at),0>at&&(at+=this.length+1);for(var sortable=this.comparator&&null==at&&options.sort!==!1,sortAttr=_.isString(this.comparator)?this.comparator:null,toAdd=[],toRemove=[],modelMap={},add=options.add,merge=options.merge,remove=options.remove,order=!sortable&&add&&remove?[]:!1,orderChanged=!1,i=0,length=models.length;length>i;i++){if(attrs=models[i],existing=this.get(attrs))remove&&(modelMap[existing.cid]=!0),merge&&attrs!==existing&&(attrs=this._isModel(attrs)?attrs.attributes:attrs,options.parse&&(attrs=existing.parse(attrs,options)),existing.set(attrs,options),sortable&&!sort&&existing.hasChanged(sortAttr)&&(sort=!0)),models[i]=existing;else if(add){if(model=models[i]=this._prepareModel(attrs,options),!model)continue;toAdd.push(model),this._addReference(model,options)}model=existing||model,model&&(id=this.modelId(model.attributes),!order||!model.isNew()&&modelMap[id]||(order.push(model),orderChanged=orderChanged||!this.models[i]||model.cid!==this.models[i].cid),modelMap[id]=!0)}if(remove){for(var i=0,length=this.length;length>i;i++)modelMap[(model=this.models[i]).cid]||toRemove.push(model);toRemove.length&&this.remove(toRemove,options)}if(toAdd.length||orderChanged)if(sortable&&(sort=!0),this.length+=toAdd.length,null!=at)for(var i=0,length=toAdd.length;length>i;i++)this.models.splice(at+i,0,toAdd[i]);else{order&&(this.models.length=0);for(var orderedModels=order||toAdd,i=0,length=orderedModels.length;length>i;i++)this.models.push(orderedModels[i])}if(sort&&this.sort({silent:!0}),!options.silent){for(var addOpts=null!=at?_.clone(options):options,i=0,length=toAdd.length;length>i;i++)null!=at&&(addOpts.index=at+i),(model=toAdd[i]).trigger("add",model,this,addOpts);(sort||orderChanged)&&this.trigger("sort",this,options)}return singular?models[0]:models},reset:function(models,options){options=options?_.clone(options):{};for(var i=0,length=this.models.length;length>i;i++)this._removeReference(this.models[i],options);return options.previousModels=this.models,this._reset(),models=this.add(models,_.extend({silent:!0},options)),options.silent||this.trigger("reset",this,options),models},push:function(model,options){return this.add(model,_.extend({at:this.length},options))},pop:function(options){var model=this.at(this.length-1);return this.remove(model,options),model},unshift:function(model,options){return this.add(model,_.extend({at:0},options))},shift:function(options){var model=this.at(0);return this.remove(model,options),model},slice:function(){return slice.apply(this.models,arguments)},get:function(obj){if(null==obj)return void 0;var id=this.modelId(this._isModel(obj)?obj.attributes:obj);return this._byId[obj]||this._byId[id]||this._byId[obj.cid]},at:function(index){return 0>index&&(index+=this.length),this.models[index]},where:function(attrs,first){var matches=_.matches(attrs);return this[first?"find":"filter"](function(model){return matches(model.attributes)})},findWhere:function(attrs){return this.where(attrs,!0)},sort:function(options){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return options||(options={}),_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(_.bind(this.comparator,this)),options.silent||this.trigger("sort",this,options),this},pluck:function(attr){return _.invoke(this.models,"get",attr)},fetch:function(options){options=options?_.clone(options):{},void 0===options.parse&&(options.parse=!0);var success=options.success,collection=this;return options.success=function(resp){var method=options.reset?"reset":"set";collection[method](resp,options),success&&success.call(options.context,collection,resp,options),collection.trigger("sync",collection,resp,options)},wrapError(this,options),this.sync("read",this,options)},create:function(model,options){if(options=options?_.clone(options):{},!(model=this._prepareModel(model,options)))return!1;options.wait||this.add(model,options);var collection=this,success=options.success;return options.success=function(model,resp){options.wait&&collection.add(model,options),success&&success.call(options.context,model,resp,options)},model.save(null,options),model},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.models,{model:this.model,comparator:this.comparator})},modelId:function(attrs){return attrs[this.model.prototype.idAttribute||"id"]},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(attrs,options){if(this._isModel(attrs))return attrs.collection||(attrs.collection=this),attrs;options=options?_.clone(options):{},options.collection=this;var model=new this.model(attrs,options);return model.validationError?(this.trigger("invalid",this,model.validationError,options),!1):model},_isModel:function(model){return model instanceof Model},_addReference:function(model,options){this._byId[model.cid]=model;var id=this.modelId(model.attributes);null!=id&&(this._byId[id]=model),model.on("all",this._onModelEvent,this)},_removeReference:function(model,options){this===model.collection&&delete model.collection,model.off("all",this._onModelEvent,this)},_onModelEvent:function(event,model,collection,options){if("add"!==event&&"remove"!==event||collection===this){if("destroy"===event&&this.remove(model,options),"change"===event){var prevId=this.modelId(model.previousAttributes()),id=this.modelId(model.attributes);prevId!==id&&(null!=prevId&&delete this._byId[prevId],null!=id&&(this._byId[id]=model))}this.trigger.apply(this,arguments)}}});var methods=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample","partition"];_.each(methods,function(method){_[method]&&(Collection.prototype[method]=function(){var args=slice.call(arguments);return args.unshift(this.models),_[method].apply(_,args)})});var attributeMethods=["groupBy","countBy","sortBy","indexBy"];_.each(attributeMethods,function(method){_[method]&&(Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _[method](this.models,iterator,context)})});var View=Backbone.View=function(options){this.cid=_.uniqueId("view"),options||(options={}),_.extend(this,_.pick(options,viewOptions)),this._ensureElement(),this.initialize.apply(this,arguments)},delegateEventSplitter=/^(\S+)\s*(.*)$/,viewOptions=["model","collection","el","id","attributes","className","tagName","events"];_.extend(View.prototype,Events,{tagName:"div",$:function(selector){return this.$el.find(selector)},initialize:function(){},render:function(){return this},remove:function(){return this._removeElement(),this.stopListening(),this},_removeElement:function(){this.$el.remove()},setElement:function(element){return this.undelegateEvents(),this._setElement(element),this.delegateEvents(),this},_setElement:function(el){this.$el=el instanceof Backbone.$?el:Backbone.$(el),this.el=this.$el[0]},delegateEvents:function(events){if(!events&&!(events=_.result(this,"events")))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(_.isFunction(method)||(method=this[events[key]]),method){var match=key.match(delegateEventSplitter);this.delegate(match[1],match[2],_.bind(method,this))}}return this},delegate:function(eventName,selector,listener){this.$el.on(eventName+".delegateEvents"+this.cid,selector,listener)},undelegateEvents:function(){return this.$el&&this.$el.off(".delegateEvents"+this.cid),this},undelegate:function(eventName,selector,listener){this.$el.off(eventName+".delegateEvents"+this.cid,selector,listener)},_createElement:function(tagName){return document.createElement(tagName)},_ensureElement:function(){if(this.el)this.setElement(_.result(this,"el"));else{var attrs=_.extend({},_.result(this,"attributes"));this.id&&(attrs.id=_.result(this,"id")),this.className&&(attrs["class"]=_.result(this,"className")),this.setElement(this._createElement(_.result(this,"tagName"))),this._setAttributes(attrs)}},_setAttributes:function(attributes){this.$el.attr(attributes)}}),Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:"json"};if(options.url||(params.url=_.result(model,"url")||urlError()),null!=options.data||!model||"create"!==method&&"update"!==method&&"patch"!==method||(params.contentType="application/json",params.data=JSON.stringify(options.attrs||model.toJSON(options))),options.emulateJSON&&(params.contentType="application/x-www-form-urlencoded",params.data=params.data?{model:params.data}:{}),options.emulateHTTP&&("PUT"===type||"DELETE"===type||"PATCH"===type)){params.type="POST",options.emulateJSON&&(params.data._method=type);var beforeSend=options.beforeSend;options.beforeSend=function(xhr){return xhr.setRequestHeader("X-HTTP-Method-Override",type),beforeSend?beforeSend.apply(this,arguments):void 0}}"GET"===params.type||options.emulateJSON||(params.processData=!1);var error=options.error;options.error=function(xhr,textStatus,errorThrown){options.textStatus=textStatus,options.errorThrown=errorThrown,error&&error.call(options.context,xhr,textStatus,errorThrown)};var xhr=options.xhr=Backbone.ajax(_.extend(params,options));return model.trigger("request",model,xhr,options),xhr};var methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var Router=Backbone.Router=function(options){options||(options={}),options.routes&&(this.routes=options.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){_.isRegExp(route)||(route=this._routeToRegExp(route)),_.isFunction(name)&&(callback=name,name=""),callback||(callback=this[name]);var router=this;return Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);router.execute(callback,args,name)!==!1&&(router.trigger.apply(router,["route:"+name].concat(args)),router.trigger("route",name,args),Backbone.history.trigger("route",router,name,args))}),this},execute:function(callback,args,name){callback&&callback.apply(this,args)},navigate:function(fragment,options){return Backbone.history.navigate(fragment,options),this},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var route,routes=_.keys(this.routes);null!=(route=routes.pop());)this.route(route,this.routes[route])}},_routeToRegExp:function(route){return route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/?]+)"}).replace(splatParam,"([^?]*?)"),new RegExp("^"+route+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param,i){return i===params.length-1?param||null:param?decodeURIComponent(param):null})}});var History=Backbone.History=function(){this.handlers=[],_.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},routeStripper=/^[#\/]|\s+$/g,rootStripper=/^\/+|\/+$/g,pathStripper=/#.*$/;History.started=!1,_.extend(History.prototype,Events,{interval:50,atRoot:function(){var path=this.location.pathname.replace(/[^\/]$/,"$&/");return path===this.root&&!this.getSearch()},getSearch:function(){var match=this.location.href.replace(/#.*/,"").match(/\?.+/);return match?match[0]:""},getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:""},getPath:function(){var path=decodeURI(this.location.pathname+this.getSearch()),root=this.root.slice(0,-1);return path.indexOf(root)||(path=path.slice(root.length)),"/"===path.charAt(0)?path.slice(1):path},getFragment:function(fragment){return null==fragment&&(fragment=this._hasPushState||!this._wantsHashChange?this.getPath():this.getHash()),fragment.replace(routeStripper,"")},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");if(History.started=!0,this.options=_.extend({root:"/"},this.options,options),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._hasHashChange="onhashchange"in window,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState),this.fragment=this.getFragment(),this.root=("/"+this.root+"/").replace(rootStripper,"/"),this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){var root=this.root.slice(0,-1)||"/";return this.location.replace(root+"#"+this.getPath()),!0}this._hasPushState&&this.atRoot()&&this.navigate(this.getHash(),{replace:!0})}if(!(this._hasHashChange||!this._wantsHashChange||this._wantsPushState&&this._hasPushState)){var iframe=document.createElement("iframe");iframe.src="javascript:0",iframe.style.display="none",iframe.tabIndex=-1;var body=document.body;this.iframe=body.insertBefore(iframe,body.firstChild).contentWindow,this.iframe.document.open().close(),this.iframe.location.hash="#"+this.fragment}var addEventListener=window.addEventListener||function(eventName,listener){return attachEvent("on"+eventName,listener)};return this._hasPushState?addEventListener("popstate",this.checkUrl,!1):this._wantsHashChange&&this._hasHashChange&&!this.iframe?addEventListener("hashchange",this.checkUrl,!1):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.options.silent?void 0:this.loadUrl()},stop:function(){var removeEventListener=window.removeEventListener||function(eventName,listener){return detachEvent("on"+eventName,listener)};this._hasPushState?removeEventListener("popstate",this.checkUrl,!1):this._wantsHashChange&&this._hasHashChange&&!this.iframe&&removeEventListener("hashchange",this.checkUrl,!1),this.iframe&&(document.body.removeChild(this.iframe.frameElement),this.iframe=null),this._checkUrlInterval&&clearInterval(this._checkUrlInterval),History.started=!1},route:function(route,callback){this.handlers.unshift({route:route,callback:callback})},checkUrl:function(e){var current=this.getFragment();return current===this.fragment&&this.iframe&&(current=this.getHash(this.iframe)),current===this.fragment?!1:(this.iframe&&this.navigate(current),void this.loadUrl())},loadUrl:function(fragment){return fragment=this.fragment=this.getFragment(fragment),_.any(this.handlers,function(handler){return handler.route.test(fragment)?(handler.callback(fragment),!0):void 0})},navigate:function(fragment,options){if(!History.started)return!1;options&&options!==!0||(options={trigger:!!options}),fragment=this.getFragment(fragment||"");var root=this.root;(""===fragment||"?"===fragment.charAt(0))&&(root=root.slice(0,-1)||"/");var url=root+fragment;if(fragment=decodeURI(fragment.replace(pathStripper,"")),this.fragment!==fragment){if(this.fragment=fragment,this._hasPushState)this.history[options.replace?"replaceState":"pushState"]({},document.title,url);else{if(!this._wantsHashChange)return this.location.assign(url);this._updateHash(this.location,fragment,options.replace),this.iframe&&fragment!==this.getHash(this.iframe)&&(options.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,fragment,options.replace))}return options.trigger?this.loadUrl(fragment):void 0}},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+"#"+fragment)}else location.hash="#"+fragment}}),Backbone.history=new History;var extend=function(protoProps,staticProps){var child,parent=this;child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&_.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified')},wrapError=function(model,options){var error=options.error;options.error=function(resp){error&&error.call(options.context,model,resp,options),model.trigger("error",model,resp,options)}};return Backbone})});